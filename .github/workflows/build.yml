name: Build & Release Mod

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Restore
      run: dotnet restore

    - name: Build (Release)
      run: dotnet build -c Release --no-restore

    - name: Read version from BepInPlugin attribute
      id: version
      shell: pwsh
      run: |
        $content = Get-Content ScrollZoom.cs -Raw
        if ($content -match 'BepInPlugin\(".*?",\s*".*?",\s*"([^"]+)"\)') {
          $ver = $matches[1]
          Write-Host "Detected version: $ver"
          echo "version=$ver" >> $env:GITHUB_OUTPUT
        } else {
          Write-Error "Could not find BepInPlugin version in ScrollZoom.cs"
          exit 1
        }

    - name: Prepare folders
      run: |
        mkdir output
        mkdir output\x64
        mkdir output\x86

    - name: Copy BepInEx templates
      run: |
        xcopy BepInExTemplates\IL2CPP_x64 output\x64 /E /I /Y
        xcopy BepInExTemplates\IL2CPP_x86 output\x86 /E /I /Y

    - name: Copy mod DLL into plugins
      run: |
        New-Item -ItemType Directory -Force -Path output\x64\BepInEx\plugins | Out-Null
        New-Item -ItemType Directory -Force -Path output\x86\BepInEx\plugins | Out-Null
        Copy-Item bin\Release\netstandard2.1\ScrollZoomMod.dll output\x64\BepInEx\plugins\
        Copy-Item bin\Release\netstandard2.1\ScrollZoomMod.dll output\x86\BepInEx\plugins\

    - name: Rename DLL for artifact
      run: |
        Copy-Item bin\Release\netstandard2.1\ScrollZoomMod.dll `
          ScrollZoom-${{ steps.version.outputs.version }}.dll

    - name: Zip x64 build (Epic / MS Store)
      run: |
        powershell Compress-Archive -Path output\x64\* `
          -DestinationPath ScrollZoom-v${{ steps.version.outputs.version }}-x64-epic-msstore.zip

    - name: Zip x86 build (Steam / Itch)
      run: |
        powershell Compress-Archive -Path output\x86\* `
          -DestinationPath ScrollZoom-v${{ steps.version.outputs.version }}-x86-steam-itch.zip

    - name: Upload DLL artifact
      uses: actions/upload-artifact@v4
      with:
        name: ScrollZoom-${{ steps.version.outputs.version }}-dll
        path: ScrollZoom-${{ steps.version.outputs.version }}.dll

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        name: Scroll Zoom v${{ steps.version.outputs.version }}
        tag_name: v${{ steps.version.outputs.version }}
        files: |
          ScrollZoom-v${{ steps.version.outputs.version }}-x64-epic-msstore.zip
          ScrollZoom-v${{ steps.version.outputs.version }}-x86-steam-itch.zip
